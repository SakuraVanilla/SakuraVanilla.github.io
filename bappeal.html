<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ban Appeal - SakuraVanilla's Website</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; max-width: 600px; margin: auto; }
    #login-section, #form-section { display: none; }
    button { padding: 10px 15px; font-size: 1rem; cursor: pointer; }
    input, textarea, select { width: 100%; margin-bottom: 10px; padding: 8px; }
  </style>
</head>
<body>

<h1>Ban Appeal</h1>

<div id="login-section">
  <p>Please login with Discord to continue:</p>
  <button id="discord-login-btn">Login with Discord</button>
</div>

<div id="form-section">
  <p>Logged in as <span id="discord-username"></span></p>
  <form id="ban-appeal-form">
    <label>Minecraft IGN:</label>
    <input type="text" id="ign" required placeholder="Your Minecraft username" />
    <label>Reason for Ban:</label>
    <select id="reason" required>
      <option value="" disabled selected>Select reason</option>
      <option value="Griefing">Griefing</option>
      <option value="Cheating/Hacking">Cheating/Hacking</option>
      <option value="Abusive Language">Abusive Language</option>
      <option value="Other">Other</option>
    </select>
    <label>Explain your appeal:</label>
    <textarea id="message" rows="5" required placeholder="Explain why you think your ban should be lifted"></textarea>
    <button type="submit">Submit Appeal</button>
  </form>
  <p id="status"></p>
  <button id="logout-btn">Logout</button>
</div>

<script>
  const clientId = "YOUR_CLIENT_ID";
  const redirectUri = "YOUR_REDIRECT_URI";  // Must be exactly this page URL
  const scope = "identify";

  const loginSection = document.getElementById('login-section');
  const formSection = document.getElementById('form-section');
  const discordUsernameSpan = document.getElementById('discord-username');
  const statusP = document.getElementById('status');
  const logoutBtn = document.getElementById('logout-btn');

  function parseHash(hash) {
    const params = {};
    hash.substring(1).split("&").forEach(kv => {
      let [key, val] = kv.split("=");
      params[key] = decodeURIComponent(val);
    });
    return params;
  }

  function setLoggedIn(user) {
    discordUsernameSpan.textContent = `${user.username}#${user.discriminator}`;
    loginSection.style.display = "none";
    formSection.style.display = "block";
  }

  function logout() {
    localStorage.removeItem("discordUser");
    loginSection.style.display = "block";
    formSection.style.display = "none";
  }

  async function fetchUserData(token) {
    try {
      const res = await fetch("https://discord.com/api/users/@me", {
        headers: { Authorization: `Bearer ${token}` }
      });
      if (!res.ok) throw new Error("Failed to fetch user data");
      return await res.json();
    } catch(e) {
      alert("Discord login failed. Please try again.");
      logout();
    }
  }

  async function init() {
    const stored = JSON.parse(localStorage.getItem("discordUser"));
    if (stored && stored.token && stored.user) {
      setLoggedIn(stored.user);
    } else {
      if (window.location.hash) {
        const params = parseHash(window.location.hash);
        if (params.access_token) {
          const user = await fetchUserData(params.access_token);
          if (user) {
            localStorage.setItem("discordUser", JSON.stringify({ token: params.access_token, user }));
            setLoggedIn(user);
            history.replaceState(null, null, window.location.pathname);
          } else {
            loginSection.style.display = "block";
          }
        } else {
          loginSection.style.display = "block";
        }
      } else {
        loginSection.style.display = "block";
      }
    }
  }

  document.getElementById("discord-login-btn").addEventListener("click", () => {
    const oauthUrl = `https://discord.com/api/oauth2/authorize?client_id=${clientId}&redirect_uri=${encodeURIComponent(redirectUri)}&response_type=token&scope=${scope}`;
    window.location.href = oauthUrl;
  });

  logoutBtn.addEventListener("click", () => {
    logout();
  });

  document.getElementById("ban-appeal-form").addEventListener("submit", async e => {
    e.preventDefault();
    statusP.textContent = "Sending...";
    const stored = JSON.parse(localStorage.getItem("discordUser"));
    if (!stored) {
      statusP.textContent = "You must be logged in.";
      return;
    }

    const webhookUrl = "YOUR_DISCORD_WEBHOOK_URL"; // Replace with your webhook URL

    const payload = {
      username: stored.user.username,
      avatar_url: `https://cdn.discordapp.com/avatars/${stored.user.id}/${stored.user.avatar}.png`,
      embeds: [{
        title: "Ban Appeal Submission",
        color: 0xe74c3c,
        fields: [
          { name: "Minecraft IGN", value: document.getElementById("ign").value, inline: true },
          { name: "Discord", value: `${stored.user.username}#${stored.user.discriminator}`, inline: true },
          { name: "Reason for Ban", value: document.getElementById("reason").value, inline: false },
          { name: "Appeal Explanation", value: document.getElementById("message").value, inline: false }
        ],
        footer: { text: `Discord ID: ${stored.user.id}` },
        timestamp: new Date().toISOString()
      }]
    };

    try {
      const res = await fetch(webhookUrl, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
      if (res.ok) {
        statusP.textContent = "Appeal sent successfully!";
        e.target.reset();
      } else {
        statusP.textContent = "Failed to send appeal.";
      }
    } catch (err) {
      statusP.textContent = "Error sending appeal.";
    }
  });

  init();
</script>

</body>
</html>
